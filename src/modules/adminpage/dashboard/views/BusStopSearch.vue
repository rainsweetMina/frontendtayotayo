<template>
  <div>
    <div class="mb-6">
      <h1 class="text-2xl font-semibold text-gray-900">Ï†ïÎ•òÏû• Í≤ÄÏÉâ</h1>
    </div>

    <!-- Í≤ÄÏÉâ ÌïÑÌÑ∞ - ÏÉÅÎã®Ïóê Î∞∞Ïπò -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-end gap-4">
        <div class="flex-grow">
          <!-- <label for="keyword" class="block text-sm font-medium text-gray-700 mb-1">Í≤ÄÏÉâÏ∞Ω ÏúÑ ÌÖçÏä§Ìä∏</label> -->
          <div class="relative rounded-md shadow-sm">
            <input
              type="text"
              id="keyword"
              v-model="keyword"
              class="block w-full rounded-md border-gray-300 pr-10 focus:border-blue-500 focus:ring-blue-500 h-10"
              placeholder="Ï†ïÎ•òÏû• Ïù¥Î¶Ñ ÎòêÎäî ID ÏûÖÎ†•"
              @keyup.enter="handleSearch"
            />
            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
          </div>
        </div>
        <div class="md:w-24">
          <button
            @click="handleSearch"
            class="w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 h-10"
          >
            Í≤ÄÏÉâ
          </button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Í≤ÄÏÉâ Í≤∞Í≥º Î™©Î°ù - ÏôºÏ™Ω -->
      <div class="lg:col-span-1">
        <div class="bg-white shadow rounded-lg overflow-hidden h-[650px] flex flex-col">
          <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <div>
              <h2 class="text-lg font-medium text-gray-900">Í≤ÄÏÉâ Í≤∞Í≥º</h2>
              <p class="text-sm text-gray-500">
                Ï¥ù {{ totalItems }}Í∞úÏùò Ï†ïÎ•òÏû•
                <span v-if="busStops.length < totalItems">
                  (ÌòÑÏû¨ {{ busStops.length }}Í∞ú Î°úÎìúÎê®)
                </span>
              </p>
            </div>
            <div class="text-sm text-blue-600" v-if="busStops.length > 0">
              {{ currentPage }} / {{ totalPages }} ÌéòÏù¥ÏßÄ
            </div>
          </div>
          <ul class="divide-y divide-gray-200 overflow-y-auto flex-grow" id="resultList">
            <li
              v-for="stop in displayedBusStops"
              :key="stop.bsId"
              class="p-4 hover:bg-gray-50 cursor-pointer"
              @click="fetchBusStopDetail(stop.bsId)"
              :class="{ 'bg-blue-50': selectedStop?.bsId === stop.bsId }"
            >
                            <div class="flex justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-900">{{ stop.bsNm }}</p>
                  <p class="text-sm text-gray-500">{{ stop.bsId }}</p>
                </div>
              </div>
            </li>
            <li v-if="busStops.length === 0" class="p-4 text-center text-gray-500">
              Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§
            </li>
          </ul>

          <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
          <div class="bg-white px-4 py-3 border-t border-gray-200">
            <div class="flex items-center justify-between">
              <div class="flex-1 flex justify-center">
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                  <!-- Îß® Ï≤òÏùå ÌéòÏù¥ÏßÄÎ°ú -->
                  <button
                    @click="handlePageChange(1)"
                    :disabled="currentPage === 1"
                    class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                    :class="{ 'opacity-50 cursor-not-allowed': currentPage === 1 }"
                  >
                    <span class="sr-only">Îß® Ï≤òÏùå</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M15.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 010 1.414zm-6 0a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 011.414 1.414L5.414 10l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                  </button>
                  
                  <!-- Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ -->
                  <button
                    @click="handlePageChange(currentPage - 1)"
                    :disabled="currentPage === 1"
                    class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                    :class="{ 'opacity-50 cursor-not-allowed': currentPage === 1 }"
                  >
                    <span class="sr-only">Ïù¥Ï†Ñ</span>
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  </button>
                  
                  <!-- ÌéòÏù¥ÏßÄ Î≤ÑÌäº -->
                  <button
                    v-for="page in displayedPageNumbers"
                    :key="page"
                    @click="handlePageChange(page)"
                    :class="[
                      'relative inline-flex items-center px-3 py-2 border text-sm font-medium',
                      currentPage === page
                        ? 'z-10 bg-blue-50 border-blue-500 text-blue-600'
                        : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                    ]"
                  >
                    {{ page }}
                  </button>
                  
                  <!-- Îã§Ïùå ÌéòÏù¥ÏßÄ -->
                  <button
                    @click="handlePageChange(currentPage + 1)"
                    :disabled="currentPage === totalPages"
                    class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                    :class="{ 'opacity-50 cursor-not-allowed': currentPage === totalPages }"
                  >
                    <span class="sr-only">Îã§Ïùå</span>
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                  </button>
                  
                  <!-- Îß® ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄÎ°ú -->
                  <button
                    @click="handlePageChange(totalPages)"
                    :disabled="currentPage === totalPages"
                    class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                    :class="{ 'opacity-50 cursor-not-allowed': currentPage === totalPages }"
                  >
                    <span class="sr-only">Îß® ÎÅù</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                      <path fill-rule="evenodd" d="M4.293 15.707a1 1 0 010-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ÏßÄÎèÑ - Ïò§Î•∏Ï™Ω -->
      <div class="lg:col-span-2">
        <div class="bg-white shadow rounded-lg p-6 h-[650px]">
          <div ref="mapContainer" id="map" class="w-full h-full rounded-lg"></div>
        </div>
      </div>
    </div>

    <!-- ÏÉÅÏÑ∏ Ï†ïÎ≥¥ - ÌïòÎã®Ïóê Î∞∞Ïπò -->
    <div v-if="selectedStop" class="mt-6 bg-white shadow rounded-lg overflow-hidden">
      <!-- Ìó§Îçî -->
      <div class="px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-800 flex justify-between items-center">
        <div>
          <h3 class="text-lg font-semibold text-white">üìç {{ selectedStop.bsNm }}</h3>
          <p class="text-sm text-blue-100">{{ selectedStop.bsId }}</p>
        </div>
        <div class="flex space-x-2">
          <button
            @click="updateBusStop"
            class="px-3 py-1 text-sm font-medium text-blue-800 bg-white rounded-md shadow-sm hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            ‚úèÔ∏è ÏàòÏ†ï
          </button>
          <button
            @click="deleteBusStop"
            class="px-3 py-1 text-sm font-medium text-white bg-red-600 rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
          >
            üóëÔ∏è ÏÇ≠Ï†ú
          </button>
        </div>
      </div>
      
      <!-- ÌÉ≠ Î©îÎâ¥ -->
      <div class="border-b border-gray-200">
        <nav class="flex -mb-px">
          <button
            v-for="(tab, index) in tabs"
            :key="index"
            @click="activeTab = tab.id"
            :class="[
              'py-4 px-6 text-sm font-medium border-b-2 focus:outline-none transition-all duration-200',
              activeTab === tab.id
                ? 'tab-active'
                : 'tab-inactive'
            ]"
          >
            <span class="flex items-center">
              <span v-html="tab.icon" class="mr-2"></span>
              {{ tab.name }}
            </span>
          </button>
        </nav>
      </div>

      <!-- ÌÉ≠ ÎÇ¥Ïö© -->
      <div class="p-6">
        <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ ÌÉ≠ -->
        <div v-if="activeTab === 'info'" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="text-lg font-medium text-gray-900 mb-4">Ï†ïÎ•òÏû• Ï†ïÎ≥¥</h4>
              <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                <div class="sm:col-span-1">
                  <dt class="text-sm font-medium text-gray-500">Ï†ïÎ•òÏû• ID</dt>
                  <dd class="mt-1 text-sm text-gray-900">{{ selectedStop.bsId }}</dd>
                </div>
                <div class="sm:col-span-1">
                  <dt class="text-sm font-medium text-gray-500">Ï†ïÎ•òÏû• Ïù¥Î¶Ñ</dt>
                  <dd class="mt-1 text-sm text-gray-900">{{ selectedStop.bsNm }}</dd>
                </div>
                <div class="sm:col-span-1">
                  <dt class="text-sm font-medium text-gray-500">Ï†ïÎ•òÏû• Ïú†Ìòï</dt>
                  <dd class="mt-1 text-sm text-gray-900">{{ selectedStop.type || selectedStop.stopType || 'ÏùºÎ∞ò' }}</dd>
                </div>
                <div class="sm:col-span-1">
                  <dt class="text-sm font-medium text-gray-500">Í¥ÄÎ¶¨ Í∏∞Í¥Ä</dt>
                  <dd class="mt-1 text-sm text-gray-900">{{ selectedStop.adminNm || 'Ï†ïÎ≥¥ ÏóÜÏùå' }}</dd>
                </div>
                <div class="sm:col-span-2">
                  <dt class="text-sm font-medium text-gray-500">Ï£ºÏÜå</dt>
                  <dd class="mt-1 text-sm text-gray-900">{{ getStopAddress(selectedStop) }}</dd>
                </div>
              </dl>
            </div>
            <div>
              <h4 class="text-lg font-medium text-gray-900 mb-4">ÏúÑÏπò Ï†ïÎ≥¥</h4>
              <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                <div class="sm:col-span-1">
                  <dt class="text-sm font-medium text-gray-500">ÏúÑÎèÑ</dt>
                  <dd class="mt-1 text-sm text-gray-900">{{ selectedStop.yPos || selectedStop.ypos }}</dd>
                </div>
                <div class="sm:col-span-1">
                  <dt class="text-sm font-medium text-gray-500">Í≤ΩÎèÑ</dt>
                  <dd class="mt-1 text-sm text-gray-900">{{ selectedStop.xPos || selectedStop.xpos }}</dd>
                </div>
                <div class="sm:col-span-2">
                  <dt class="text-sm font-medium text-gray-500">ÏÑ§Î™Ö</dt>
                  <dd class="mt-1 text-sm text-gray-900">{{ selectedStop.description || 'Ï†ïÎ≥¥ ÏóÜÏùå' }}</dd>
                </div>
              </dl>
            </div>
          </div>
        </div>

        <!-- ÎÖ∏ÏÑ† Ï†ïÎ≥¥ ÌÉ≠ -->
        <div v-if="activeTab === 'routes'" class="space-y-4">
          <div v-if="selectedStop.routes && selectedStop.routes.length > 0">
            <ul class="divide-y divide-gray-200">
              <li v-for="route in selectedStop.routes" :key="route.routeId" class="py-4 flex items-center">
                <div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center" :class="getBusTypeClass(route.type)">
                  <span class="font-bold text-white">{{ route.routeNo }}</span>
                </div>
                <div class="ml-4">
                  <p class="text-sm font-medium text-gray-900">{{ route.routeName }}</p>
                  <p class="text-xs text-gray-500">{{ getBusTypeText(route.type) }} | {{ route.startStop }} ‚Üí {{ route.endStop }}</p>
                </div>
              </li>
            </ul>
          </div>
          <div v-else class="text-center py-8">
            <p class="text-gray-500">ÎÖ∏ÏÑ† Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§</p>
          </div>
        </div>

        <!-- ÏãúÏÑ§Î¨º ÌÉ≠ -->
        <div v-if="activeTab === 'facilities'" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="flex items-center space-x-3 p-3 rounded-lg" :class="{ 'bg-blue-50': hasFacility('shelter') }">
              <div class="flex-shrink-0 h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-900">ÏäπÍ∞ù ÎåÄÍ∏∞ ÏâòÌÑ∞</p>
                <p class="text-xs text-gray-500">{{ hasFacility('shelter') ? 'ÏÑ§ÏπòÎê®' : 'ÎØ∏ÏÑ§Ïπò' }}</p>
              </div>
            </div>
            
            <div class="flex items-center space-x-3 p-3 rounded-lg" :class="{ 'bg-green-50': hasFacility('bench') }">
              <div class="flex-shrink-0 h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-900">Î≤§Ïπò</p>
                <p class="text-xs text-gray-500">{{ hasFacility('bench') ? 'ÏÑ§ÏπòÎê®' : 'ÎØ∏ÏÑ§Ïπò' }}</p>
              </div>
            </div>
            
            <div class="flex items-center space-x-3 p-3 rounded-lg" :class="{ 'bg-purple-50': hasFacility('lcd') }">
              <div class="flex-shrink-0 h-10 w-10 rounded-full bg-purple-100 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-900">ÎèÑÏ∞© Ï†ïÎ≥¥ ÏïàÎÇ¥ Îã®ÎßêÍ∏∞</p>
                <p class="text-xs text-gray-500">{{ hasFacility('lcd') ? 'ÏÑ§ÏπòÎê®' : 'ÎØ∏ÏÑ§Ïπò' }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed, watch, nextTick, onBeforeUnmount } from 'vue'
import { useRouter } from 'vue-router'
import api from '@/api/axiosInstance'
import { searchBusStops as searchBusStopsApi, getAllBusStops, getBusStopDetail, deleteBusStop as deleteBusStopApi, getBusStopsInBounds } from '@/api/busStop'
import 'leaflet/dist/leaflet.css'
import L from 'leaflet'

// ÏÉÅÌÉú Î≥ÄÏàò
const mapContainer = ref(null)
let map = null
let geocoder = null
const markers = ref([])
const activeTab = ref('info')

// ÌÉ≠ Ï†ïÏùò
const tabs = [
  { 
    id: 'info', 
    name: 'Í∏∞Î≥∏ Ï†ïÎ≥¥', 
    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>'
  },
  { 
    id: 'routes', 
    name: 'ÎÖ∏ÏÑ† Ï†ïÎ≥¥', 
    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z" /><path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>'
  },
  { 
    id: 'facilities', 
    name: 'ÏãúÏÑ§Î¨º', 
    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>'
  }
]

// Í≤ÄÏÉâ Í¥ÄÎ†® Î≥ÄÏàò
const keyword = ref('')
const facilities = ref({})

// Í≤∞Í≥º Í¥ÄÎ†® Î≥ÄÏàò
const busStops = ref([])
const selectedStop = ref(null)
const currentPage = ref(1)
const totalPages = ref(1)
const totalItems = ref(0)
const itemsPerPage = 10
const defaultCenter = [35.8714, 128.6014] // ÎåÄÍµ¨ Ï§ëÏã¨ Ï¢åÌëú

// Ï£ºÏÜå Ï∫êÏã±ÏùÑ ÏúÑÌïú Í∞ùÏ≤¥
const addressCache = ref({})

// ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê ÌëúÏãúÌï† Ï†ïÎ•òÏû• Î™©Î°ù Í≥ÑÏÇ∞
const displayedBusStops = computed(() => {
  const start = (currentPage.value - 1) * itemsPerPage
  const end = start + itemsPerPage
  return busStops.value.slice(start, end)
})

// ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò - ÌëúÏãúÌï† ÌéòÏù¥ÏßÄ Î≤àÌò∏ Í≥ÑÏÇ∞
const displayedPageNumbers = computed(() => {
  const result = []
  const maxDisplayed = 5 // Ìïú Î≤àÏóê ÌëúÏãúÌï† ÌéòÏù¥ÏßÄ Î≤àÌò∏ Í∞úÏàò
  
  // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Í∏∞Ï§ÄÏúºÎ°ú ÌëúÏãúÌï† ÌéòÏù¥ÏßÄ Î≤îÏúÑ Í≥ÑÏÇ∞
  let startPage = Math.max(1, Math.floor((currentPage.value - 1) / maxDisplayed) * maxDisplayed + 1)
  let endPage = Math.min(totalPages.value, startPage + maxDisplayed - 1)
    
    for (let i = startPage; i <= endPage; i++) {
      result.push(i)
  }
  
  return result
})

// ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
const initMap = async () => {
  await nextTick()
  
  if (!mapContainer.value) {
    console.error('Map container not found')
    return
  }

  try {
    // Í∏∞Î≥∏ ÏúÑÏπòÎ°ú ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî (ÎÇòÏ§ëÏóê ÌòÑÏû¨ ÏúÑÏπòÎ°ú Î≥ÄÍ≤ΩÎê† Ïàò ÏûàÏùå)
    map = L.map(mapContainer.value, {
      center: defaultCenter,
      zoom: 15,
      zoomAnimation: true,
      markerZoomAnimation: true
    })
    
    // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÏÉÅÌÉú ÏÑ§Ï†ï (Ï≤òÏùåÏóêÎäî falseÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Ï≤´ ÎßàÏª§ ÏÉùÏÑ± ÏãúÏóêÎßå Î≤îÏúÑ Ïû¨ÏÑ§Ï†ï)
    map._mapInitialized = false;
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map)
    
    // Nominatim Ïó≠ÏßÄÏò§ÏΩîÎî© ÏÑúÎπÑÏä§ Ï¥àÍ∏∞Ìôî (Î∞±ÏóîÎìú ÌîÑÎ°ùÏãú API ÏÇ¨Ïö©)
    geocoder = L.Nominatim = {
      reverseGeocode: async (lat, lng) => {
        try {
          // Î∞±ÏóîÎìú ÌîÑÎ°ùÏãú API ÏÇ¨Ïö©
          const { reverseGeocode } = await import('@/api/axiosInstance');
          return await reverseGeocode(lat, lng);
        } catch (error) {
          console.error('Ïó≠ÏßÄÏò§ÏΩîÎî© Ïò§Î•ò:', error);
          return null;
        }
      }
    };
    
    // ÌòÑÏû¨ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞ ÏãúÎèÑ
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        // ÏÑ±Í≥µ Ïãú
        (position) => {
          const { latitude, longitude, accuracy } = position.coords;
          console.log('ÌòÑÏû¨ ÏúÑÏπò:', latitude, longitude);
          console.log('ÏúÑÏπò Ï†ïÌôïÎèÑ:', accuracy, 'meters');
          
          // ÏßÄÎèÑ Ï§ëÏã¨ Î≥ÄÍ≤Ω (ÏûêÎèô Ïù¥ÎèôÏûÑÏùÑ ÌëúÏãú)
          map._isAutomaticMove = true;
          map.setView([latitude, longitude], 15);
          
          // ÌòÑÏû¨ ÏúÑÏπò ÎßàÏª§ Ï∂îÍ∞Ä
          const currentLocationIcon = L.divIcon({
            className: 'current-location-icon',
            html: `
              <div class="current-location-marker">
                <div class="pulse"></div>
                <div class="accuracy-circle" style="width:${accuracy}px;height:${accuracy}px"></div>
              </div>
            `,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });
          
          const currentLocationMarker = L.marker([latitude, longitude], {
            icon: currentLocationIcon,
            zIndexOffset: 1000
          }).addTo(map);

          // Ï†ïÌôïÎèÑ Ïõê Ï∂îÍ∞Ä
          L.circle([latitude, longitude], {
            radius: accuracy,
            color: '#4A90E2',
            fillColor: '#4A90E2',
            fillOpacity: 0.15
          }).addTo(map);

          // ÌòÑÏû¨ ÏúÑÏπò Í∏∞Î∞òÏúºÎ°ú Ï£ºÎ≥Ä Ï†ïÎ•òÏû• Í≤ÄÏÉâ 
          // Î∞òÍ≤ΩÏùÑ 500mÎ°ú Í≥†Ï†ï
          const searchRadius = 500;
          searchNearbyBusStops(latitude, longitude, searchRadius);
        },
        // Ïã§Ìå® Ïãú
        (error) => {
          console.error('ÌòÑÏû¨ ÏúÑÏπò Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
          alert('ÌòÑÏû¨ ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏñ¥ Í∏∞Î≥∏ ÏúÑÏπòÎ°ú ÏßÄÎèÑÎ•º ÌëúÏãúÌï©ÎãàÎã§.');
          // Í∏∞Î≥∏ Í≤ÄÏÉâ ÏàòÌñâ
          handleSearch();
        },
        // ÏòµÏÖò
        {
          enableHighAccuracy: true, // ÎÜíÏùÄ Ï†ïÌôïÎèÑ ÏöîÏ≤≠
          timeout: 10000, // 10Ï¥àÎ°ú ÎäòÎ¶º
          maximumAge: 30000 // 30Ï¥à Ïù¥ÎÇ¥ Ï∫êÏãúÎêú ÏúÑÏπò ÌóàÏö©
        }
      );
    } else {
      console.warn('Geolocation APIÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.');
      // Í∏∞Î≥∏ Í≤ÄÏÉâ ÏàòÌñâ
      handleSearch();
    }
    console.log('Leaflet ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å')
  } catch (error) {
    console.error('ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error)
  }
}

// ÌòÑÏû¨ ÏúÑÏπò Ï£ºÎ≥Ä Ï†ïÎ•òÏû• Í≤ÄÏÉâ
const searchNearbyBusStops = async (latitude, longitude, radius) => {
  try {
    console.log(`ÌòÑÏû¨ ÏúÑÏπò(${latitude}, ${longitude}) Î∞òÍ≤Ω ${radius}m ÎÇ¥ Ï†ïÎ•òÏû• Í≤ÄÏÉâ (Î∞±ÏóîÎìú API ÏÇ¨Ïö©)`);
    
    // Ï†ïÎ•òÏû• Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÌëúÏãú
    busStops.value = [];
    totalItems.value = 0;
    
    // Î∞±ÏóîÎìú APIÎ•º ÌÜµÌï¥ Î∞òÍ≤Ω ÎÇ¥ Ï†ïÎ•òÏû• Í≤ÄÏÉâ
    const apiUrl = `/api/bus/nearbyBusStops?lat=${latitude}&lon=${longitude}&radius=${radius}`;
    console.log('API ÏöîÏ≤≠:', apiUrl);
    
    const response = await api.get(apiUrl);
    
    if (!response || !response.data) {
      console.error('Ï†ïÎ•òÏû• Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§:', response);
      alert('Ï†ïÎ•òÏû• Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      return;
    }
    
    const stopsFromApi = response.data || [];
    
    console.log(`Î∞±ÏóîÎìúÏóêÏÑú Î∞òÌôòÎêú Ï†ïÎ•òÏû•: ${stopsFromApi.length}Í∞ú`);
    console.log('Ï†ïÎ•òÏû• Îç∞Ïù¥ÌÑ∞ ÏÉòÌîå:', stopsFromApi.slice(0, 2));
    
    if (stopsFromApi.length === 0) {
      console.warn('Î∞òÍ≤Ω ÎÇ¥ Ï†ïÎ•òÏû•Ïù¥ ÏóÜÏäµÎãàÎã§. Í∏∞Î≥∏ Í≤ÄÏÉâÏùÑ ÏàòÌñâÌï©ÎãàÎã§.');
      handleSearch();
      return;
    }
    
    // Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
    busStops.value = stopsFromApi;
    totalItems.value = stopsFromApi.length;
    totalPages.value = Math.ceil(stopsFromApi.length / itemsPerPage) || 1;
    currentPage.value = 1;
    
    // Î∞òÍ≤Ω ÌëúÏãú Ïõê Ï∂îÍ∞Ä
    if (map) {
      // Í∏∞Ï°¥ Ïõê Ï†úÍ±∞
      map.eachLayer(layer => {
        if (layer instanceof L.Circle) {
          map.removeLayer(layer);
        }
      });
      
      // Î∞òÍ≤ΩÏùÑ 500mÎ°ú Í≥†Ï†ïÌïòÏó¨ ÌëúÏãú
      const displayRadius = 500;
      
      L.circle([latitude, longitude], {
        radius: displayRadius,
        color: '#2563eb',
        fillColor: '#3b82f6',
        fillOpacity: 0.1,
        weight: 2,
        opacity: 0.5
      }).addTo(map);
    }
    
    // ÎßàÏª§ ÏÉùÏÑ± (Ï≤òÏùå Î°úÎìú ÏãúÏóêÎäî ÏßÄÎèÑ Î≤îÏúÑ Ïû¨ÏÑ§Ï†ï ÌóàÏö©)
    // ÌòÑÏû¨ ÏúÑÏπò Í∏∞Î∞ò Í≤ÄÏÉâÏùÄ Ï¥àÍ∏∞ Î°úÎìúÎ°ú Í∞ÑÏ£º
    map._mapInitialized = false;
    await createMarkers();
    
  } catch (error) {
    console.error('Ï£ºÎ≥Ä Ï†ïÎ•òÏû• Í≤ÄÏÉâ Ïã§Ìå®:', error);
    alert('Ï£ºÎ≥Ä Ï†ïÎ•òÏû•ÏùÑ Í≤ÄÏÉâÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    
    // Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏ Í≤ÄÏÉâ ÏàòÌñâ
    handleSearch();
  }
};

// Îëê Ï¢åÌëú ÏÇ¨Ïù¥Ïùò Í±∞Î¶¨ Í≥ÑÏÇ∞ (Haversine Í≥µÏãù, ÎØ∏ÌÑ∞ Îã®ÏúÑ Î∞òÌôò)
const calculateDistance = (lat1, lon1, lat2, lon2) => {
  const R = 6371e3; // ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (ÎØ∏ÌÑ∞)
  const œÜ1 = lat1 * Math.PI / 180; // œÜ, Œª in radians
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
          Math.cos(œÜ1) * Math.cos(œÜ2) *
          Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // ÎØ∏ÌÑ∞ Îã®ÏúÑ Í±∞Î¶¨
};

// Ï†ïÎ•òÏû•Ïùò Ï£ºÏÜå Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
const getStopAddress = (stop) => {
  // Ï£ºÏÜå Ï†ïÎ≥¥Í∞Ä ÏûàÎäî Í≤ΩÏö∞ ÏÇ¨Ïö©
  if (stop.city || stop.district || stop.neighborhood) {
    const addressParts = []
    if (stop.city) addressParts.push(stop.city)
    if (stop.district) addressParts.push(stop.district)
    if (stop.neighborhood) addressParts.push(stop.neighborhood)
    return addressParts.join(' ')
  }
  
  // Ïó≠ÏßÄÏò§ÏΩîÎî©ÏúºÎ°ú Í∞ÄÏ†∏Ïò® Ï£ºÏÜåÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
  if (stop.geocodedAddress) {
    // Ï¢åÌëú ÌòïÏãùÏùò Ï£ºÏÜåÎäî ÌëúÏãúÌïòÏßÄ ÏïäÏùå
    if (stop.geocodedAddress.startsWith('Ï¢åÌëú:') || stop.geocodedAddress.startsWith('ÏúÑÎèÑ:')) {
      return 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå'
    }
    return stop.geocodedAddress
  }
  
  // Ï¢åÌëú Ï†ïÎ≥¥ ÌôïÏù∏
  let xpos = stop.xPos !== undefined ? stop.xPos : stop.xpos
  let ypos = stop.yPos !== undefined ? stop.yPos : stop.ypos
    
  if (!ypos || !xpos) return 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå'
    
  // Ï¢åÌëúÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Î©¥ Ïà´ÏûêÎ°ú Î≥ÄÌôò
  const lat = typeof ypos === 'string' ? parseFloat(ypos) : ypos
  const lng = typeof xpos === 'string' ? parseFloat(xpos) : xpos
    
  if (isNaN(lat) || isNaN(lng)) return 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå'
  
  // Ï∫êÏãú ÌÇ§ ÏÉùÏÑ± (ÏÜåÏàòÏ†ê 5ÏûêÎ¶¨ÍπåÏßÄÎßå ÏÇ¨Ïö©ÌïòÏó¨ ÎπÑÏä∑Ìïú Ï¢åÌëúÎäî Í∞ôÏùÄ Ï£ºÏÜåÎ°ú Ï≤òÎ¶¨)
  const cacheKey = `${Math.round(lat * 100000) / 100000},${Math.round(lng * 100000) / 100000}`
  
  // Ï∫êÏãúÏóê ÏûàÏúºÎ©¥ Ï∫êÏãúÎêú Í∞í Î∞òÌôò
  if (addressCache.value[cacheKey]) {
    // Ï¢åÌëú ÌòïÏãùÏùò Ï£ºÏÜåÎäî ÌëúÏãúÌïòÏßÄ ÏïäÏùå
    if (addressCache.value[cacheKey].startsWith('Ï¢åÌëú:') || addressCache.value[cacheKey].startsWith('ÏúÑÎèÑ:')) {
      return 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå'
    }
    return addressCache.value[cacheKey]
  }
  
  // Ïù¥ÎØ∏ Î°úÎìú ÏãúÎèÑ Ï§ëÏù∏ÏßÄ ÌôïÏù∏ÌïòÍ∏∞ ÏúÑÌïú ÌîåÎûòÍ∑∏
  if (!stop.addressLoading) {
    // Î°úÎî© Ï§ë ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
    stop.addressLoading = true;
    
    // Ï£ºÏÜå Ï†ïÎ≥¥Í∞Ä ÏóÜÎäî Î™®Îì† Ï†ïÎ•òÏû•Ïóê ÎåÄÌï¥ Ï£ºÏÜå Î°úÎìú ÏãúÎèÑ
    getAddressFromCoordinates(lat, lng).then(address => {
      if (address) {
        // ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
        stop.addressLoading = false;
        Object.assign(stop, { geocodedAddress: address });
      }
    }).catch(error => {
      // ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
      stop.addressLoading = false;
      console.warn('Ï£ºÏÜå Î°úÎìú Ïã§Ìå®:', error);
      // Ïò§Î•ò Ïãú Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùåÏúºÎ°ú ÌëúÏãú
      Object.assign(stop, { geocodedAddress: 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå' });
    });
  }
  
  // Î°úÎî© Ï§ëÏù∏ Í≤ΩÏö∞ Í∞ÑÍ≤∞Ìïú Î©îÏãúÏßÄ ÌëúÏãú
  return 'Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎî© Ï§ë';
}

// Ï¢åÌëúÎ°ú Ï£ºÏÜå Í∞ÄÏ†∏Ïò§Í∏∞ (Ï∫êÏã± Ï†ÅÏö©)
const getAddressFromCoordinates = async (lat, lng) => {
  if (!geocoder) return null;
  
  // Ï∫êÏãú ÌÇ§ ÏÉùÏÑ± (ÏÜåÏàòÏ†ê 5ÏûêÎ¶¨ÍπåÏßÄÎßå ÏÇ¨Ïö©ÌïòÏó¨ ÎπÑÏä∑Ìïú Ï¢åÌëúÎäî Í∞ôÏùÄ Ï£ºÏÜåÎ°ú Ï≤òÎ¶¨)
  const cacheKey = `${Math.round(lat * 100000) / 100000},${Math.round(lng * 100000) / 100000}`;
  
  // Ï∫êÏãúÏóê ÏûàÏúºÎ©¥ Ï∫êÏãúÎêú Í∞í Î∞òÌôò
  if (addressCache.value[cacheKey]) {
    return addressCache.value[cacheKey];
  }
  
  // ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ Ïó≠ÏßÄÏò§ÏΩîÎî© ÏöîÏ≤≠ Ïàò ÌôïÏù∏ Î∞è Ï†úÌïú
  if (!window._activeGeocodingRequests) {
    window._activeGeocodingRequests = 0;
  }
  
  // ÎèôÏãú ÏöîÏ≤≠Ïù¥ 5Í∞úÎ•º Ï¥àÍ≥ºÌïòÎ©¥ ÎåÄÍ∏∞
  if (window._activeGeocodingRequests >= 5) {
    // Í∏∞Î≥∏ Ï£ºÏÜå Î∞òÌôò (ÎÇòÏ§ëÏóê Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏)
    const tempAddress = 'Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎî© Ï§ë...';
    
    // Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÎÇòÏ§ëÏóê Î°úÎìú ÏãúÎèÑ
    setTimeout(() => {
      getAddressFromCoordinates(lat, lng).then(address => {
        if (address && address !== 'Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎî© Ï§ë...') {
          addressCache.value[cacheKey] = address;
          
          // ÎßàÏª§ ÌåùÏóÖ ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏ (Ìï¥Îãπ Ï¢åÌëúÏùò ÎßàÏª§ Ï∞æÍ∏∞)
          const marker = markers.value.find(m => {
            const pos = m.getLatLng();
            return Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001;
          });
          
          if (marker && marker.getPopup()) {
            // ÎßàÏª§Ïùò ÌåùÏóÖ ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
            const popupContent = marker.getPopup().getContent();
            if (popupContent) {
              const updatedContent = popupContent.replace(/Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎî© Ï§ë\.\.\./, address);
              marker.getPopup().setContent(updatedContent);
            }
          }
          
          // ÏÑ†ÌÉùÎêú Ï†ïÎ•òÏû•Ïùò Ï£ºÏÜåÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
          if (selectedStop.value) {
            const stopLat = selectedStop.value.yPos || selectedStop.value.ypos;
            const stopLng = selectedStop.value.xPos || selectedStop.value.xpos;
            
            if (Math.abs(stopLat - lat) < 0.0001 && Math.abs(stopLng - lng) < 0.0001) {
              selectedStop.value.geocodedAddress = address;
            }
          }
        }
      }).catch(error => {
        console.warn('Î∞±Í∑∏ÎùºÏö¥Îìú Ï£ºÏÜå Î°úÎìú Ïã§Ìå®:', error);
      });
    }, Math.random() * 2000 + 1000); // 1-3Ï¥à ÏÇ¨Ïù¥ ÎûúÎç§ ÎîúÎ†àÏù¥
    
    return tempAddress;
  }
  
  try {
    // ÌôúÏÑ± ÏöîÏ≤≠ Ïπ¥Ïö¥ÌÑ∞ Ï¶ùÍ∞Ä
    window._activeGeocodingRequests++;
    
    // API Ìò∏Ï∂ú ÏãúÍ∞Ñ Ï†úÌïú ÏÑ§Ï†ï (5Ï¥àÎ°ú Ï¶ùÍ∞Ä)
    const timeoutPromise = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Ïó≠ÏßÄÏò§ÏΩîÎî© API ÌÉÄÏûÑÏïÑÏõÉ')), 5000)
    );
    
    // API Ìò∏Ï∂úÍ≥º ÌÉÄÏûÑÏïÑÏõÉ Ï§ë Î®ºÏ†Ä ÏôÑÎ£åÎêòÎäî Í≤É Ï≤òÎ¶¨
    const result = await Promise.race([
      geocoder.reverseGeocode(lat, lng),
      timeoutPromise
    ]);
    
    if (result && result.display_name) {
      // Ï£ºÏÜå ÌòïÏãù Î≥ÄÌôò (ÎåÄÌïúÎØºÍµ≠, Ïö∞Ìé∏Î≤àÌò∏ Ï†úÍ±∞ Î∞è ÌïúÍµ≠ ÌëúÍ∏∞ Î∞©ÏãùÏúºÎ°ú Î≥ÄÍ≤Ω)
      let address = result.display_name;
      
      // "ÎåÄÌïúÎØºÍµ≠" ÎòêÎäî "South Korea" Ï†úÍ±∞
      address = address.replace(/(ÎåÄÌïúÎØºÍµ≠|South Korea),?\s*/g, '');
      
      // Ïö∞Ìé∏Î≤àÌò∏ Ìå®ÌÑ¥ Ï†úÍ±∞ (Ïòà: 12345, 123-456)
      address = address.replace(/\b\d{5}\b|\b\d{3}-\d{3}\b,?\s*/g, '');
      
      // Ï£ºÏÜå ÏöîÏÜå Ï∂îÏ∂ú Î∞è Ïû¨Íµ¨ÏÑ±
      if (result.address) {
        const addressParts = [];
        
        // ÌïúÍµ≠ Ï£ºÏÜå ÌòïÏãùÏúºÎ°ú Íµ¨ÏÑ± (Ïãú/ÎèÑ > Íµ∞/Íµ¨ > Ïùç/Î©¥/Îèô > ÏÉÅÏÑ∏Ï£ºÏÜå)
        if (result.address.state) addressParts.push(result.address.state);
        if (result.address.county) addressParts.push(result.address.county);
        if (result.address.city) addressParts.push(result.address.city);
        if (result.address.town) addressParts.push(result.address.town);
        if (result.address.suburb) addressParts.push(result.address.suburb);
        if (result.address.village) addressParts.push(result.address.village);
        if (result.address.neighbourhood) addressParts.push(result.address.neighbourhood);
        if (result.address.road) addressParts.push(result.address.road);
        
        if (addressParts.length > 0) {
          const formattedAddress = addressParts.join(' ');
          // Í≤∞Í≥ºÎ•º Ï∫êÏãúÏóê Ï†ÄÏû•
          addressCache.value[cacheKey] = formattedAddress;
          
          // ÌôúÏÑ± ÏöîÏ≤≠ Ïπ¥Ïö¥ÌÑ∞ Í∞êÏÜå
          window._activeGeocodingRequests--;
          
          return formattedAddress;
        }
      }
      
      // Ï£ºÏÜå Í∞ùÏ≤¥ÏóêÏÑú Ï∂îÏ∂ú Ïã§Ìå®Ìïú Í≤ΩÏö∞ Í∏∞Î≥∏ Î¨∏ÏûêÏó¥ÏóêÏÑú Ï≤òÎ¶¨
      const formattedAddress = address.trim();
      // Í≤∞Í≥ºÎ•º Ï∫êÏãúÏóê Ï†ÄÏû•
      addressCache.value[cacheKey] = formattedAddress;
      
      // ÌôúÏÑ± ÏöîÏ≤≠ Ïπ¥Ïö¥ÌÑ∞ Í∞êÏÜå
      window._activeGeocodingRequests--;
      
      return formattedAddress;
    }
  } catch (error) {
    console.error('Ï£ºÏÜå Î≥ÄÌôò Ïò§Î•ò:', error);
    
    // Ïò§Î•ò Î∞úÏÉù Ïãú Í∏∞Î≥∏ Î©îÏãúÏßÄ ÏÇ¨Ïö©
    const fallbackAddress = 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå';
    
    // Ïò§Î•ò Î∞úÏÉù ÏãúÏóêÎèÑ Ï∫êÏãúÏóê Ï†ÄÏû• (Î∞òÎ≥µÏ†ÅÏù∏ API Ìò∏Ï∂ú Î∞©ÏßÄ)
    addressCache.value[cacheKey] = fallbackAddress;
    
    // ÌôúÏÑ± ÏöîÏ≤≠ Ïπ¥Ïö¥ÌÑ∞ Í∞êÏÜå
    window._activeGeocodingRequests--;
    
    return fallbackAddress;
  }
  
  // ÌôúÏÑ± ÏöîÏ≤≠ Ïπ¥Ïö¥ÌÑ∞ Í∞êÏÜå (Ïó¨Í∏∞ÍπåÏßÄ ÎèÑÎã¨ÌïòÎ©¥ Ïò§Î•ò Î∞úÏÉù)
  window._activeGeocodingRequests--;
  
  return null;
}

// Ï†ïÎ•òÏû• Í≤ÄÏÉâ (ÌÇ§ÏõåÎìú ÏûÖÎ†• Ïãú)
const handleKeywordSearch = async () => {
  if (!keyword.value || keyword.value.trim().length < 1) {
    busStops.value = []
    totalItems.value = 0
    totalPages.value = 1
    return
  }
  
  try {
    console.log(`ÌÇ§ÏõåÎìúÎ°ú Í≤ÄÏÉâ: "${keyword.value}"`)
    let result = []
    let totalCount = 0
    const searchKeyword = keyword.value.trim()
    
    // Ïà´ÏûêÎ°úÎßå Ïù¥Î£®Ïñ¥ÏßÑ Í≤ΩÏö∞ IDÎ°ú Í∞ÑÏ£ºÌïòÏó¨ ÏÉÅÏÑ∏ Í≤ÄÏÉâ ÏãúÎèÑ
    const isNumeric = /^\d+$/.test(searchKeyword)
    
    if (isNumeric) {
      try {
        console.log('Ï†ïÎ•òÏû• IDÎ°ú Í≤ÄÏÉâ ÏãúÎèÑ:', searchKeyword)
        const stopDetail = await getBusStopDetail(searchKeyword)
        if (stopDetail && stopDetail.bsId) {
          result = [stopDetail]
          totalCount = 1
        }
      } catch (detailError) {
        console.warn('Ï†ïÎ•òÏû• IDÎ°ú ÏÉÅÏÑ∏ Í≤ÄÏÉâ Ïã§Ìå®:', detailError)
      }
    }
    
    // ID Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÍ±∞ÎÇò Ïà´ÏûêÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ
    if (result.length === 0) {
      console.log('Ï†ïÎ•òÏû• Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ ÏãúÎèÑ:', searchKeyword)
      const nameSearchResponse = await searchBusStopsApi(searchKeyword)
      if (nameSearchResponse) {
        // API ÏùëÎãµ ÌòïÏãùÏóê Îî∞Îùº Ï≤òÎ¶¨
        if (Array.isArray(nameSearchResponse)) {
          // Î∞∞Ïó¥Î°ú ÏùëÎãµÏù¥ Ïò® Í≤ΩÏö∞
          result = nameSearchResponse
          totalCount = nameSearchResponse.length
        } else if (nameSearchResponse.content && Array.isArray(nameSearchResponse.content)) {
          // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Í∞ùÏ≤¥Î°ú ÏùëÎãµÏù¥ Ïò® Í≤ΩÏö∞
          result = nameSearchResponse.content
          totalCount = nameSearchResponse.totalElements || result.length
        }
      }
    }
    
    if (!result || !Array.isArray(result)) {
      console.warn('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÍ±∞ÎÇò Î∞∞Ïó¥Ïù¥ ÏïÑÎãò:', result)
      busStops.value = []
      totalItems.value = 0
      totalPages.value = 1
      return
    }
    
    console.log(`Í≤ÄÏÉâ Í≤∞Í≥º: ${result.length}Í∞ú Ï†ïÎ•òÏû• Ï∞æÏùå, Ï†ÑÏ≤¥: ${totalCount}Í∞ú`)
    
    // Í≤ÄÏÉâ Í≤∞Í≥ºÏóê Ï∫êÏãúÎêú Ï£ºÏÜå Ï†ïÎ≥¥ Ï†ÅÏö©
    result.forEach(stop => {
      // Ï¢åÌëú Ï†ïÎ≥¥ ÌôïÏù∏
      let xpos = stop.xPos !== undefined ? stop.xPos : stop.xpos
      let ypos = stop.yPos !== undefined ? stop.yPos : stop.ypos
      
      if (ypos && xpos) {
        // Ï¢åÌëúÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Î©¥ Ïà´ÏûêÎ°ú Î≥ÄÌôò
        const lat = typeof ypos === 'string' ? parseFloat(ypos) : ypos
        const lng = typeof xpos === 'string' ? parseFloat(xpos) : xpos
        
        if (!isNaN(lat) && !isNaN(lng)) {
          // Ï∫êÏãú ÌÇ§ ÏÉùÏÑ±
          const cacheKey = `${Math.round(lat * 100000) / 100000},${Math.round(lng * 100000) / 100000}`
          
          // Ï∫êÏãúÎêú Ï£ºÏÜåÍ∞Ä ÏûàÏúºÎ©¥ Ï†ÅÏö©
          if (addressCache.value[cacheKey]) {
            Object.assign(stop, { geocodedAddress: addressCache.value[cacheKey] })
          }
        }
      }
    })
    
    busStops.value = result
    
    // Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎ©¥ Î∞îÎ°ú Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎìú ÏãúÎèÑ
    nextTick(() => {
      loadAddressesForVisibleStops();
    });
    totalItems.value = totalCount
    totalPages.value = Math.ceil(busStops.value.length / itemsPerPage) || 1 // Ïã§Ï†ú Î∂àÎü¨Ïò® Îç∞Ïù¥ÌÑ∞ Í∏∞Ï§ÄÏúºÎ°ú ÌéòÏù¥ÏßÄ Í≥ÑÏÇ∞
    currentPage.value = 1
    
    if (map) {
      await createMarkers()
    }
    
    // Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú ÌõÑ Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎìú
    nextTick(() => {
      loadAddressesForVisibleStops();
    });
  } catch (error) {
    console.error('Ï†ïÎ•òÏû• Í≤ÄÏÉâ Ïã§Ìå®:', error)
    busStops.value = []
    totalItems.value = 0
    totalPages.value = 1
  }
}

// Ï†ïÎ•òÏû• Í≤ÄÏÉâ (Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú)
const handleSearch = async () => {
  try {
    console.log('Í≤ÄÏÉâ ÏãúÏûë:', { keyword: keyword.value })
    
    // ÌÇ§ÏõåÎìúÍ∞Ä ÏûàÏúºÎ©¥ ÌÇ§ÏõåÎìú Í≤ÄÏÉâ Ìï®Ïàò Ïû¨ÏÇ¨Ïö©
    if (keyword.value && keyword.value.trim() !== '') {
      await handleKeywordSearch()
    } else {
      // ÌÇ§ÏõåÎìúÍ∞Ä ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ Ï†ïÎ•òÏû• Ï°∞Ìöå
      const response = await getAllBusStops('', 0, 100)
      let result = response.content || []
      
      // Í≤ÄÏÉâ Í≤∞Í≥ºÏóê Ï∫êÏãúÎêú Ï£ºÏÜå Ï†ïÎ≥¥ Ï†ÅÏö©
      result.forEach(stop => {
        // Ï¢åÌëú Ï†ïÎ≥¥ ÌôïÏù∏
        let xpos = stop.xPos !== undefined ? stop.xPos : stop.xpos
        let ypos = stop.yPos !== undefined ? stop.yPos : stop.ypos
        
        if (ypos && xpos) {
          // Ï¢åÌëúÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Î©¥ Ïà´ÏûêÎ°ú Î≥ÄÌôò
          const lat = typeof ypos === 'string' ? parseFloat(ypos) : ypos
          const lng = typeof xpos === 'string' ? parseFloat(xpos) : xpos
          
          if (!isNaN(lat) && !isNaN(lng)) {
            // Ï∫êÏãú ÌÇ§ ÏÉùÏÑ±
            const cacheKey = `${Math.round(lat * 100000) / 100000},${Math.round(lng * 100000) / 100000}`
            
            // Ï∫êÏãúÎêú Ï£ºÏÜåÍ∞Ä ÏûàÏúºÎ©¥ Ï†ÅÏö©
            if (addressCache.value[cacheKey]) {
              Object.assign(stop, { geocodedAddress: addressCache.value[cacheKey] })
            }
          }
        }
      })
      
      // Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
      busStops.value = result
      totalItems.value = response.totalElements || result.length // Ï†ÑÏ≤¥ Ï†ïÎ•òÏû• Ïàò (APIÏóêÏÑú Ï†úÍ≥µÌïòÎäî Í≤ΩÏö∞)
      totalPages.value = Math.ceil(busStops.value.length / itemsPerPage) || 1 // Ïã§Ï†ú Î∂àÎü¨Ïò® Îç∞Ïù¥ÌÑ∞ Í∏∞Ï§ÄÏúºÎ°ú ÌéòÏù¥ÏßÄ Í≥ÑÏÇ∞
      currentPage.value = 1
      
      if (map) {
        // Í≤ÄÏÉâ Î≤ÑÌäºÏúºÎ°ú Í≤ÄÏÉâ ÏãúÏóêÎäî Ï≤òÏùå Î°úÎìúÎ°ú Í∞ÑÏ£ºÌïòÏó¨ ÏßÄÎèÑ Î≤îÏúÑ Ïû¨ÏÑ§Ï†ï ÌóàÏö©
        map._mapInitialized = false;
        await createMarkers()
      }
      
      // Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú ÌõÑ Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎìú
      nextTick(() => {
        loadAddressesForVisibleStops();
      });
    }
  } catch (error) {
    console.error('Ï†ïÎ•òÏû• Í≤ÄÏÉâ Ïã§Ìå®:', error)
    alert('Ï†ïÎ•òÏû• Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    busStops.value = []
    totalItems.value = 0
    totalPages.value = 1
  }
}

// Ï†ïÎ•òÏû• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå
const fetchBusStopDetail = async (bsId) => {
  try {
    console.log(`Ï†ïÎ•òÏû• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå: ${bsId}`)
    const data = await getBusStopDetail(bsId)
    
    if (!data) {
      console.error('Ï†ïÎ•òÏû• Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.')
      return
    }
    
    // Ï¢åÌëú ÌôïÏù∏ (ÎåÄÏÜåÎ¨∏Ïûê Î™®Îëê ÌôïÏù∏)
    let xpos = data.xPos !== undefined ? data.xPos : data.xpos
    let ypos = data.yPos !== undefined ? data.yPos : data.ypos
    
    if (ypos && xpos) {
      // Ï¢åÌëúÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Î©¥ Ïà´ÏûêÎ°ú Î≥ÄÌôò
      const lat = typeof ypos === 'string' ? parseFloat(ypos) : ypos
      const lng = typeof xpos === 'string' ? parseFloat(xpos) : xpos
      
      if (!isNaN(lat) && !isNaN(lng)) {
        // Ï£ºÏÜå Ï†ïÎ≥¥Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ Ïó≠ÏßÄÏò§ÏΩîÎî©ÏúºÎ°ú Ï£ºÏÜå Í∞ÄÏ†∏Ïò§Í∏∞
        if (!data.city && !data.district && !data.neighborhood && !data.geocodedAddress) {
          // Ï∫êÏãú ÌôïÏù∏
          const cacheKey = `${Math.round(lat * 100000) / 100000},${Math.round(lng * 100000) / 100000}`;
          const cachedAddress = addressCache.value[cacheKey];
          
          if (cachedAddress) {
            // Ï∫êÏãúÎêú Ï£ºÏÜåÍ∞Ä ÏûàÏúºÎ©¥ Î∞îÎ°ú Ï†ÅÏö©
            data.geocodedAddress = cachedAddress;
            
            // Í≤ÄÏÉâ Í≤∞Í≥º Î™©Î°ùÏùò Ìï¥Îãπ Ï†ïÎ•òÏû•ÏóêÎèÑ Ï†ÅÏö©
            const stopInList = busStops.value.find(stop => stop.bsId === data.bsId);
            if (stopInList) {
              stopInList.geocodedAddress = cachedAddress;
            }
          } else {
            // Ï∫êÏãúÎêú Ï£ºÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ïó≠ÏßÄÏò§ÏΩîÎî© ÏàòÌñâ
            try {
              const address = await getAddressFromCoordinates(lat, lng);
              if (address) {
                data.geocodedAddress = address;
                console.log('Ïó≠ÏßÄÏò§ÏΩîÎî© Ï£ºÏÜå:', address);
                
                // Ï£ºÏÜå Ï†ïÎ≥¥Î•º Í≤ÄÏÉâ Í≤∞Í≥º Î™©Î°ùÏùò Ìï¥Îãπ Ï†ïÎ•òÏû•ÏóêÎèÑ Ï†ÅÏö©
                const stopInList = busStops.value.find(stop => stop.bsId === data.bsId);
                if (stopInList) {
                  Object.assign(stopInList, { geocodedAddress: address });
                }
                
                // ÎßàÏª§ ÌåùÏóÖ ÎÇ¥Ïö©ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                const marker = markers.value.find(m => {
                  const pos = m.getLatLng()
                  return Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001
                });
                
                if (marker && marker.getPopup()) {
                  marker.getPopup().setContent(`
                    <div class="popup-content">
                      <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #2563eb;">${data.bsNm}</h3>
                      <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">ID: ${data.bsId}</p>
                      <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">${address}</p>
                    </div>
                  `);
                }
              }
            } catch (geoError) {
              console.warn('Ïó≠ÏßÄÏò§ÏΩîÎî© Ïã§Ìå®:', geoError);
            }
          }
        }
      }
    }
    
    // ÏÑ†ÌÉùÎêú Ï†ïÎ•òÏû• Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
    selectedStop.value = data
    
    // ÏßÄÎèÑÏóê ÎßàÏª§ ÌëúÏãú
    if (map) {
      // Ï¢åÌëú ÌôïÏù∏ (ÎåÄÏÜåÎ¨∏Ïûê Î™®Îëê ÌôïÏù∏)
      let xpos = data.xPos !== undefined ? data.xPos : data.xpos
      let ypos = data.yPos !== undefined ? data.yPos : data.ypos
      
      if (!ypos || !xpos) {
        console.warn('Ï†ïÎ•òÏû• Ï¢åÌëú ÏóÜÏùå:', data.bsId, data.bsNm)
        return
      }
      
      // Ï¢åÌëúÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Î©¥ Ïà´ÏûêÎ°ú Î≥ÄÌôò
      const lat = typeof ypos === 'string' ? parseFloat(ypos) : ypos
      const lng = typeof xpos === 'string' ? parseFloat(xpos) : xpos
      
      if (isNaN(lat) || isNaN(lng)) {
        console.warn('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ï¢åÌëú:', data.bsId, data.bsNm, ypos, xpos)
        return
      }
      
      // ÏßÄÎèÑ Ïù¥Îèô (ÏûêÎèô Ïù¥ÎèôÏûÑÏùÑ ÌëúÏãú)
      map._isAutomaticMove = true;
      map.setView([lat, lng], 16)
      
      // ÏÑ†ÌÉùÌïú Ï†ïÎ•òÏû•Ïùò ÎßàÏª§ Ï∞æÍ∏∞
      const marker = markers.value.find(m => {
        const pos = m.getLatLng()
        return Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001
      })
      
      // ÎßàÏª§Í∞Ä ÏûàÏúºÎ©¥ ÌåùÏóÖ Ïó¥Í∏∞
      if (marker) {
        // Ï£ºÏÜå Ï†ïÎ≥¥Í∞Ä ÏûàÏúºÎ©¥ ÌåùÏóÖ ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
        const address = getStopAddress(data);
        if (address !== 'Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎî© Ï§ë...') {
          marker.getPopup().setContent(`
            <div class="popup-content">
              <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #2563eb;">${data.bsNm}</h3>
              <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">ID: ${data.bsId}</p>
              <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">${address}</p>
            </div>
          `);
        }
        marker.openPopup()
      }
    }
  } catch (error) {
    console.error('Ï†ïÎ•òÏû• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:', error)
    alert('Ï†ïÎ•òÏû• Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.')
  }
}

// ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω
const handlePageChange = (page) => {
  if (page < 1 || page > totalPages.value) return
  currentPage.value = parseInt(page)
  
  // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω Ïãú Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏúÑÎ°ú Ïù¥Îèô
  const resultList = document.getElementById('resultList')
  if (resultList) {
    resultList.scrollTop = 0
  }
  
  // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω ÌõÑ ÌëúÏãúÎêòÎäî Ï†ïÎ•òÏû•Ïùò Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎìú
  nextTick(() => {
    loadAddressesForVisibleStops();
  });
}

// Ï†ïÎ•òÏû• ÏÇ≠Ï†ú
const deleteBusStop = async () => {
  if (!selectedStop.value) return
  
  if (!confirm(`Ï†ïÎßêÎ°ú Ï†ïÎ•òÏû• [${selectedStop.value.bsId}]ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return
  
  try {
    await deleteBusStopApi(selectedStop.value.bsId)
    alert('‚úÖ Ï†ïÎ•òÏû•Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.')
    
    // Î™©Î°ùÏóêÏÑú Ï†úÍ±∞
    busStops.value = busStops.value.filter(stop => stop.bsId !== selectedStop.value.bsId)
    totalItems.value = busStops.value.length
    totalPages.value = Math.ceil(totalItems.value / itemsPerPage) || 1
    
    // ÏÑ†ÌÉù Ìï¥Ï†ú
    selectedStop.value = null
    
    // ÎßàÏª§ Ïû¨ÏÉùÏÑ±
    await createMarkers()
  } catch (error) {
    console.error('Ï†ïÎ•òÏû• ÏÇ≠Ï†ú Ïã§Ìå®:', error)
    alert('‚ùå ÏÇ≠Ï†ú ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
  }
}

// Ï†ïÎ•òÏû• ÏàòÏ†ï ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
const updateBusStop = () => {
  if (!selectedStop.value) return
  window.location.href = `/UpdateBusStop?bsId=${encodeURIComponent(selectedStop.value.bsId)}`
}

// ÏãúÏÑ§Î¨º ÌôïÏù∏ Ìï®Ïàò
const hasFacility = (type) => {
  if (!selectedStop.value || !selectedStop.value.facilities) return false
  return !!selectedStop.value.facilities[type]
}

// ÎÖ∏ÏÑ† ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î≥¥Í∏∞
const viewRouteDetails = (routeId) => {
  if (!routeId) return
  window.location.href = `/RouteDetail?routeId=${encodeURIComponent(routeId)}`
}

// ÎßàÏª§ ÏÉùÏÑ± Î∞è Í¥ÄÎ¶¨
const createMarkers = async () => {
  // Í∏∞Ï°¥ ÎßàÏª§ Ï†úÍ±∞
  if (markers.value.length > 0) {
    markers.value.forEach(marker => {
      if (map) map.removeLayer(marker)
    })
    markers.value = []
  }

  if (!busStops.value || busStops.value.length === 0) {
    console.log('ÌëúÏãúÌï† Ï†ïÎ•òÏû•Ïù¥ ÏóÜÏäµÎãàÎã§.')
    return
  }

  // Ïª§Ïä§ÌÖÄ ÎßàÏª§ ÏïÑÏù¥ÏΩò Ï†ïÏùò
  const busStopIcon = L.divIcon({
    className: 'custom-bus-stop-icon',
    html: `
      <div class="marker-container">
        <div class="marker-base">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="bus-icon">
            <path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/>
          </svg>
        </div>
        <div class="marker-pole"></div>
        <div class="marker-shadow"></div>
      </div>
    `,
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
  });

  // ÏÉàÎ°úÏö¥ ÎßàÏª§ ÏÉùÏÑ±
  const validStops = []
  const markerLayer = L.layerGroup().addTo(map)
  
  // Ï†ïÎ•òÏû• Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Î∞è ÎßàÏª§ ÏÉùÏÑ±
  for (const stop of busStops.value) {
    // Ï¢åÌëú Ï†ïÎ≥¥ ÌôïÏù∏ (ÎåÄÏÜåÎ¨∏Ïûê Î™®Îëê ÌôïÏù∏)
    let xpos = stop.xPos !== undefined ? stop.xPos : stop.xpos
    let ypos = stop.yPos !== undefined ? stop.yPos : stop.ypos
    
    if (!ypos || !xpos) {
      console.warn('Ï†ïÎ•òÏû• Ï¢åÌëú ÏóÜÏùå:', stop.bsId, stop.bsNm)
      continue
    }
    
    // Ï¢åÌëúÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Î©¥ Ïà´ÏûêÎ°ú Î≥ÄÌôò
    const lat = typeof ypos === 'string' ? parseFloat(ypos) : ypos
    const lng = typeof xpos === 'string' ? parseFloat(xpos) : xpos
    
    if (isNaN(lat) || isNaN(lng)) {
      console.warn('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ï¢åÌëú:', stop.bsId, stop.bsNm, ypos, xpos)
      continue
    }

    try {
      // ÎßàÏª§ ÏÉùÏÑ±
      const marker = L.marker([lat, lng], {
        icon: busStopIcon,
        riseOnHover: true,
        bubblingMouseEvents: false
      }).addTo(markerLayer)

      // Ï£ºÏÜå Ï†ïÎ≥¥ ÎØ∏Î¶¨ Î°úÎìú (Ï∫êÏãú ÌôïÏù∏)
      const cacheKey = `${Math.round(lat * 100000) / 100000},${Math.round(lng * 100000) / 100000}`;
      const cachedAddress = addressCache.value[cacheKey];
      
      if (cachedAddress) {
        // Ï∫êÏãúÎêú Ï£ºÏÜåÍ∞Ä ÏûàÏúºÎ©¥ Î∞îÎ°ú Ï†ÅÏö©
        stop.geocodedAddress = cachedAddress;
      }

      // ÌåùÏóÖ Ï∂îÍ∞Ä - Ïä§ÌÉÄÏùº Í∞úÏÑ†
      const address = getStopAddress(stop);
      marker.bindPopup(`
        <div class="popup-content">
          <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #2563eb;">${stop.bsNm}</h3>
          <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">ID: ${stop.bsId}</p>
          <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">${address !== 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå' ? address : 'Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎî© Ï§ë...'}</p>
        </div>
      `, {
        className: 'custom-popup',
        closeButton: false,
        autoClose: false,
        closeOnEscapeKey: false
      })

      // Ï£ºÏÜå Ï†ïÎ≥¥Í∞Ä ÏóÜÏúºÎ©¥ ÎπÑÎèôÍ∏∞Î°ú Î°úÎìú
      if (address === 'Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎî© Ï§ë...') {
        getAddressFromCoordinates(lat, lng).then(fetchedAddress => {
          if (fetchedAddress) {
            stop.geocodedAddress = fetchedAddress;
            // ÌåùÏóÖ ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
            if (marker && marker.getPopup()) {
              marker.getPopup().setContent(`
                <div class="popup-content">
                  <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #2563eb;">${stop.bsNm}</h3>
                  <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">ID: ${stop.bsId}</p>
                  <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">${fetchedAddress}</p>
                </div>
              `);
            }
          }
        }).catch(error => {
          console.warn('Ï£ºÏÜå Î°úÎìú Ïã§Ìå®:', error);
        });
      }

      // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
      marker.on('click', () => {
        fetchBusStopDetail(stop.bsId)
      })

      markers.value.push(marker)
      validStops.push({ lat, lng })
    } catch (error) {
      console.error('ÎßàÏª§ ÏÉùÏÑ± Ïò§Î•ò:', error, stop)
    }
  }

  // ÏßÄÎèÑ Î≤îÏúÑ Ïû¨ÏÑ§Ï†ï - Ï¥àÍ∏∞ Î°úÎìú ÏãúÏóêÎßå Ï†ÅÏö© (ÏßÄÎèÑ Ïù¥Îèô ÏãúÏóêÎäî Ï†ÅÏö©ÌïòÏßÄ ÏïäÏùå)
  if (validStops.length > 0 && !map._mapInitialized) {
    try {
      const bounds = L.latLngBounds(validStops.map(coord => [coord.lat, coord.lng]))
      // ÏûêÎèô Ïù¥ÎèôÏûÑÏùÑ ÌëúÏãú
      map._isAutomaticMove = true;
      map.fitBounds(bounds.pad(0.1))
      // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÌëúÏãú
      map._mapInitialized = true;
    } catch (error) {
      console.error('ÏßÄÎèÑ Î≤îÏúÑ ÏÑ§Ï†ï Ïò§Î•ò:', error)
      map._isAutomaticMove = true;
      map.setView(defaultCenter, 12)
      map._mapInitialized = true;
    }
  } else if (!map._mapInitialized) {
    console.warn('ÌëúÏãúÌï† ÎßàÏª§Í∞Ä ÏóÜÏäµÎãàÎã§.')
    map._isAutomaticMove = true;
    map.setView(defaultCenter, 12)
    map._mapInitialized = true;
  }
  // Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎêú ÏßÄÎèÑÎäî Î≤îÏúÑÎ•º Ïû¨ÏÑ§Ï†ïÌïòÏßÄ ÏïäÏùå
  
  // ÌòÑÏû¨ ÌôîÎ©¥Ïóê ÌëúÏãúÎêòÎäî Ï†ïÎ•òÏû•Ïùò Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎìú
  loadAddressesForVisibleStops();
}

// ÌòÑÏû¨ ÌôîÎ©¥Ïóê ÌëúÏãúÎêòÎäî Ï†ïÎ•òÏû•Ïùò Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎìú
const loadAddressesForVisibleStops = async () => {
  // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê ÌëúÏãúÎêòÎäî Ï†ïÎ•òÏû•Îßå Ï≤òÎ¶¨
  const promises = [];
  let loadCount = 0;
  
  for (const stop of displayedBusStops.value) {
    if (!stop.city && !stop.district && !stop.neighborhood && !stop.geocodedAddress) {
      // Ï¢åÌëú Ï†ïÎ≥¥ ÌôïÏù∏ (ÎåÄÏÜåÎ¨∏Ïûê Î™®Îëê ÌôïÏù∏)
      let xpos = stop.xPos !== undefined ? stop.xPos : stop.xpos
      let ypos = stop.yPos !== undefined ? stop.yPos : stop.ypos
      
      if (!ypos || !xpos) continue;
      
      // Ï¢åÌëúÍ∞Ä Î¨∏ÏûêÏó¥Ïù¥Î©¥ Ïà´ÏûêÎ°ú Î≥ÄÌôò
      const lat = typeof ypos === 'string' ? parseFloat(ypos) : ypos
      const lng = typeof xpos === 'string' ? parseFloat(xpos) : xpos
      
      if (isNaN(lat) || isNaN(lng)) continue;
      
      // Ï∫êÏãú ÌôïÏù∏
      const cacheKey = `${Math.round(lat * 100000) / 100000},${Math.round(lng * 100000) / 100000}`;
      const cachedAddress = addressCache.value[cacheKey];
      
      if (cachedAddress) {
        // Ï∫êÏãúÎêú Ï£ºÏÜåÍ∞Ä ÏûàÏúºÎ©¥ Î∞îÎ°ú Ï†ÅÏö©
        Object.assign(stop, { geocodedAddress: cachedAddress });
        continue; // Ï∫êÏãúÏóêÏÑú Í∞ÄÏ†∏ÏôîÏúºÎØÄÎ°ú API Ìò∏Ï∂ú Î∂àÌïÑÏöî
      }
      
      // Ïù¥ÎØ∏ Î°úÎìú ÏãúÎèÑ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
      if (stop.addressLoading) continue;
      
      // Î°úÎìú Ï§ë ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
      stop.addressLoading = true;
      
      // Ìïú Î≤àÏóê ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÎèôÏãú Î°úÎìú
      if (loadCount < 3) {
        loadCount++;
        
        // ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥ Ï∂îÍ∞Ä (Í∞Å ÏöîÏ≤≠ ÏÇ¨Ïù¥Ïóê 100-300ms Í∞ÑÍ≤©)
        const delayTime = loadCount * (Math.random() * 200 + 100);
        
        const loadPromise = new Promise(resolve => {
          setTimeout(async () => {
            try {
              const address = await getAddressFromCoordinates(lat, lng);
              if (address) {
                // ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
                stop.addressLoading = false;
                Object.assign(stop, { geocodedAddress: address });
                
                // ÎßàÏª§ ÌåùÏóÖ ÎÇ¥Ïö©ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                const marker = markers.value.find(m => {
                  const pos = m.getLatLng()
                  return Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001
                });
                
                if (marker && marker.getPopup()) {
                  marker.getPopup().setContent(`
                    <div class="popup-content">
                      <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #2563eb;">${stop.bsNm}</h3>
                      <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">ID: ${stop.bsId}</p>
                      <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">${address}</p>
                    </div>
                  `);
                }
              }
            } catch (geoError) {
              // ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
              stop.addressLoading = false;
              console.warn('Ïó≠ÏßÄÏò§ÏΩîÎî© Ïã§Ìå®:', geoError);
              
              // Ïò§Î•ò Ïãú Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùåÏúºÎ°ú ÌëúÏãú
              const fallbackAddress = 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå';
              Object.assign(stop, { geocodedAddress: fallbackAddress });
              
              // ÎßàÏª§ ÌåùÏóÖ ÎÇ¥Ïö©ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
              const marker = markers.value.find(m => {
                const pos = m.getLatLng()
                return Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001
              });
              
              if (marker && marker.getPopup()) {
                marker.getPopup().setContent(`
                  <div class="popup-content">
                    <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #2563eb;">${stop.bsNm}</h3>
                    <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">ID: ${stop.bsId}</p>
                    <p style="margin: 2px 0; font-size: 13px; color: #4b5563;">Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå</p>
                  </div>
                `);
              }
            }
            resolve();
          }, delayTime);
        });
        
        promises.push(loadPromise);
      } else {
        // ÎÇòÎ®∏ÏßÄÎäî Í∏∞Î≥∏ Ï£ºÏÜåÎ°ú ÌëúÏãúÌïòÍ≥† ÎÇòÏ§ëÏóê Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú Î°úÎìú
        Object.assign(stop, { geocodedAddress: 'Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎî© Ï§ë...' });
        
        // Î∞±Í∑∏ÎùºÏö¥Îìú Î°úÎìúÎ•º ÏúÑÌï¥ ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï (5-10Ï¥à ÌõÑ)
        setTimeout(() => {
          if (stop.addressLoading) {
            getAddressFromCoordinates(lat, lng).then(address => {
              if (address) {
                stop.addressLoading = false;
                Object.assign(stop, { geocodedAddress: address });
              }
            }).catch(() => {
              stop.addressLoading = false;
            });
          }
        }, 5000 + Math.random() * 5000);
      }
    }
  }
  
  // Î™®Îì† Ï£ºÏÜå Î°úÎî© ÏôÑÎ£å ÎåÄÍ∏∞ (ÏµúÎåÄ 3Í∞ú)
  if (promises.length > 0) {
    await Promise.all(promises);
  }
};

// ÎßàÏª§ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
const updateMarkers = () => {
  if (!map || markers.value.length === 0) return
  
  markers.value.forEach(marker => {
    marker.update()
  })
  
  console.log('ÎßàÏª§ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å')
}

// Ïª¥Ìè¨ÎÑåÌä∏Í∞Ä Ïñ∏ÎßàÏö¥Ìä∏Îê† Îïå Ï†ïÎ¶¨
onBeforeUnmount(() => {
  // ÎßàÏª§ Ï†ïÎ¶¨
  if (markers.value.length > 0) {
    markers.value.forEach(marker => {
      if (map) map.removeLayer(marker)
    })
    markers.value = []
  }
  
  // ÏßÄÎèÑ Ï†ïÎ¶¨
  if (map) {
    map.remove()
    map = null
  }
})

// ÏßÄÎèÑ ÏòÅÏó≠ ÎÇ¥ Ï†ïÎ•òÏû• Î∂àÎü¨Ïò§Í∏∞
const loadBusStopsInView = async () => {
  if (!map) return;
  
  // ÌòÑÏû¨ Ï§å Î†àÎ≤® ÌôïÏù∏ - ÎÑàÎ¨¥ ÏûëÏùÄ Ï§å Î†àÎ≤®ÏóêÏÑúÎäî Ï†ïÎ•òÏû•ÏùÑ Î∂àÎü¨Ïò§ÏßÄ ÏïäÏùå
  const currentZoom = map.getZoom();
  if (currentZoom < 14) {
    console.log(`Ï§å Î†àÎ≤®(${currentZoom})Ïù¥ ÎÑàÎ¨¥ ÏûëÏïÑ Ï†ïÎ•òÏû•ÏùÑ Î∂àÎü¨Ïò§ÏßÄ ÏïäÏäµÎãàÎã§. (ÏµúÏÜå 14 Ïù¥ÏÉÅ)`);
    return;
  }
  
  // ÌòÑÏû¨ ÏßÄÎèÑ ÌôîÎ©¥Ïùò Ï¢åÌëú Î≤îÏúÑ Íµ¨ÌïòÍ∏∞
  const bounds = map.getBounds();
  const sw = bounds.getSouthWest();
  const ne = bounds.getNorthEast();
  
  // ÏòÅÏó≠Ïù¥ ÎÑàÎ¨¥ ÎÑìÏùÄ Í≤ΩÏö∞ Í≤ÄÏÉâÌïòÏßÄ ÏïäÏùå (Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ)
  const latDiff = Math.abs(ne.lat - sw.lat);
  const lngDiff = Math.abs(ne.lng - sw.lng);
  
  if (latDiff > 0.1 || lngDiff > 0.1) {
    console.log('Í≤ÄÏÉâ ÏòÅÏó≠Ïù¥ ÎÑàÎ¨¥ ÎÑìÏäµÎãàÎã§. Îçî ÌôïÎåÄÌï¥Ï£ºÏÑ∏Ïöî.');
    return;
  }
  
  try {
    console.log(`ÏßÄÎèÑ ÏòÅÏó≠ ÎÇ¥ Ï†ïÎ•òÏû• Í≤ÄÏÉâ: (${sw.lng}, ${sw.lat}) ~ (${ne.lng}, ${ne.lat})`);
    
    // API Ìò∏Ï∂úÌï¥ÏÑú Ï†ïÎ•òÏû• Îç∞Ïù¥ÌÑ∞ Î∞õÏïÑÏò§Í∏∞
    const stopsFromApi = await getBusStopsInBounds(sw.lng, sw.lat, ne.lng, ne.lat);
    console.log(`ÏßÄÎèÑ ÏòÅÏó≠ ÎÇ¥ Ï†ïÎ•òÏû•: ${stopsFromApi.length}Í∞ú`);
    
    // Í≤∞Í≥ºÍ∞Ä ÎÑàÎ¨¥ ÎßéÏùÄ Í≤ΩÏö∞ Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùå (Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ)
    if (stopsFromApi.length > 300) {
      console.log(`Ï†ïÎ•òÏû•Ïù¥ ÎÑàÎ¨¥ ÎßéÏäµÎãàÎã§(${stopsFromApi.length}Í∞ú). Îçî ÌôïÎåÄÌï¥Ï£ºÏÑ∏Ïöî.`);
      return;
    }
    
    // Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏
    busStops.value = stopsFromApi;
    totalItems.value = stopsFromApi.length;
    totalPages.value = Math.ceil(stopsFromApi.length / itemsPerPage) || 1;
    currentPage.value = 1;
    
    // ÎßàÏª§ ÏÉùÏÑ± - ÏßÄÎèÑ Î≤îÏúÑ Ïû¨ÏÑ§Ï†ï ÏóÜÏù¥ ÎßàÏª§Îßå ÏÉùÏÑ±
    map._isAutomaticMove = true;
    // ÏßÄÎèÑ Ïù¥Îèô ÏãúÏóêÎäî Ï¥àÍ∏∞ÌôîÎêú ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Î≤îÏúÑ Ïû¨ÏÑ§Ï†ï Î∞©ÏßÄ
    map._mapInitialized = true;
    await createMarkers();
    
    // Ï£ºÏÜå Ï†ïÎ≥¥Îäî Ï†êÏßÑÏ†ÅÏúºÎ°ú Î°úÎìú (Ìïú Î≤àÏóê Î™®Îëê Î°úÎìúÌïòÏßÄ ÏïäÏùå)
    nextTick(() => {
      loadAddressesForVisibleStops();
    });
    
  } catch (error) {
    console.error('ÏßÄÎèÑ ÏòÅÏó≠ ÎÇ¥ Ï†ïÎ•òÏû• Í≤ÄÏÉâ Ïã§Ìå®:', error);
  }
};

// Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú Ï¥àÍ∏∞Ìôî
onMounted(async () => {
  await initMap()
  
  // URL ÌååÎùºÎØ∏ÌÑ∞ ÌôïÏù∏
  const params = new URLSearchParams(window.location.search)
  const bsId = params.get('bsId')
  
  if (bsId) {
    // ÌäπÏ†ï Ï†ïÎ•òÏû• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå
    await fetchBusStopDetail(bsId)
  }
  // Í∏∞Î≥∏ Í≤ÄÏÉâÏùÄ initMapÏóêÏÑú ÌòÑÏû¨ ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò® ÌõÑ ÏàòÌñâÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî Ï†úÍ±∞

  // ÏßÄÎèÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
  if (map) {
    map.on('zoomend', () => {
      console.log('ÏßÄÎèÑ Ï§å Î†àÎ≤® Î≥ÄÍ≤Ω:', map.getZoom())
      updateMarkers()
    })

    map.on('moveend', () => {
      console.log('ÏßÄÎèÑ Ïù¥Îèô ÏôÑÎ£å')
      // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÏßÄÎèÑÎ•º Ïù¥ÎèôÌïú Í≤ΩÏö∞ÏóêÎßå Ï†ïÎ•òÏû• Î°úÎìú
      if (!map._isAutomaticMove) {
        loadBusStopsInView();
      }
      // ÏûêÎèô Ïù¥Îèô ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
      map._isAutomaticMove = false;
    })

    // ÏßÄÎèÑ Î°úÎìú ÏôÑÎ£å ÌõÑ ÎßàÏª§ Ïû¨Î∞∞Ïπò
    map.whenReady(() => {
      console.log('ÏßÄÎèÑ Î°úÎìú ÏôÑÎ£å')
      updateMarkers()
    })
  }
  
  // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê ÌëúÏãúÎêòÎäî Ï†ïÎ•òÏû•Ïùò Ï£ºÏÜå Ï†ïÎ≥¥ Î°úÎìú
  nextTick(() => {
    loadAddressesForVisibleStops();
  });
})

// Í≤ÄÏÉâ Í≤∞Í≥º Î™©Î°ù Í∞±Ïã† Ïãú Ï£ºÏÜå Ï†ïÎ≥¥ÎèÑ Ìï®Íªò ÏóÖÎç∞Ïù¥Ìä∏
watch(() => displayedBusStops.value, () => {
  nextTick(() => {
    loadAddressesForVisibleStops();
  });
}, { deep: true });
</script>

<style scoped>
/* Leaflet ÎßàÏª§ Ïä§ÌÉÄÏùº Ï°∞Ï†ï */
:deep(.leaflet-div-icon) {
  background: transparent;
  border: none;
}

/* Ïª§Ïä§ÌÖÄ Î≤ÑÏä§ Ï†ïÎ•òÏû• ÎßàÏª§ Ïä§ÌÉÄÏùº */
:deep(.custom-bus-stop-icon) {
  background: transparent;
  border: none;
}

:deep(.marker-container) {
  position: relative;
  width: 40px;
  height: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

:deep(.marker-base) {
  position: absolute;
  top: 0;
  width: 28px;
  height: 28px;
  background: #2563eb;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
  border: 2px solid white;
}

:deep(.bus-icon) {
  width: 18px;
  height: 18px;
  color: white;
}

:deep(.marker-pole) {
  position: absolute;
  top: 28px;
  width: 4px;
  height: 12px;
  background: #2563eb;
  z-index: 1;
}

:deep(.marker-shadow) {
  position: absolute;
  bottom: 0;
  width: 14px;
  height: 3px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 50%;
  filter: blur(1px);
}

/* ÌòÑÏû¨ ÏúÑÏπò ÎßàÏª§ Ïä§ÌÉÄÏùº */
:deep(.current-location-marker) {
  position: relative;
  width: 20px;
  height: 20px;
}

:deep(.current-location-marker::before) {
  content: '';
  position: absolute;
  width: 14px;
  height: 14px;
  background: #3b82f6;
  border-radius: 50%;
  top: 3px;
  left: 3px;
  z-index: 2;
  border: 2px solid white;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
}

:deep(.pulse) {
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: rgba(59, 130, 246, 0.4);
  animation: pulse 2s infinite;
  z-index: 1;
}

@keyframes pulse {
  0% {
    transform: scale(0.5);
    opacity: 1;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}

/* ÌåùÏóÖ Ïä§ÌÉÄÏùº Ï°∞Ï†ï */
:deep(.leaflet-popup-content-wrapper) {
  padding: 3px;
  border-radius: 8px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

:deep(.custom-popup) {
  min-width: 200px;
}

:deep(.custom-popup .leaflet-popup-content-wrapper) {
  background-color: white;
  border-radius: 8px;
  overflow: hidden;
}

:deep(.custom-popup .leaflet-popup-tip) {
  background-color: white;
}

:deep(.custom-popup .leaflet-popup-content) {
  margin: 10px 12px;
  font-size: 0.95rem;
  font-weight: 500;
  line-height: 1.4;
}

:deep(.popup-content) {
  text-align: center;
}

/* ÌÉ≠ Ïä§ÌÉÄÏùº Í∞úÏÑ† */
.tab-active {
  color: #2563eb;
  border-color: #2563eb;
  font-weight: 600;
}

.tab-inactive {
  color: #6b7280;
  border-color: transparent;
  font-weight: 500;
}

.tab-inactive:hover {
  color: #374151;
  border-color: #d1d5db;
}
</style> 